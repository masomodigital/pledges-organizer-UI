<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Masomo Pledges Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f9f9f9;
    }

    h2, h3, h4 { text-align: center; }

    #dashboard { display: none; margin-top: 20px; max-width: 1000px; margin: 0 auto; }

    .table-wrapper { overflow-x: auto; }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
      min-width: 800px;
    }

    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }

    th {
      background: #0077cc;
      color: white;
      position: sticky;
      top: 0;
    }

    input { padding: 5px; margin: 5px 0; width: 100%; max-width: 200px; box-sizing: border-box; }

    button {
      padding: 5px 12px;
      margin: 2px 2px 2px 0;
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
      font-weight: bold;
    }

    button:hover { opacity: 0.9; }

    .btn-add-event { background: #28a745; }
    .btn-add-contrib { background: #17a2b8; }
    .btn-close { background: #dc3545; }

    .addContributorRow input { width: 120px; margin-right: 5px; }

    #loginDiv {
      max-width: 300px;
      margin: 0 auto;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0px 2px 5px rgba(0,0,0,0.2);
    }

    #waitMsg {
      display: none;
      font-weight: bold;
      color: #0077cc;
      text-align: center;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h2>Masomo Pledges Dashboard</h2>

  <p id="waitMsg">Wait please...</p>

  <!-- LOGIN -->
  <div id="loginDiv">
    <input type="text" id="nationalId" placeholder="National ID"><br>
    <input type="password" id="password" placeholder="Password"><br>
    <button class="btn-add-event" onclick="login()">Login</button>
    <p id="loginMsg" style="color:red;"></p>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard">
    <h3 id="welcomeMsg"></h3>

    <!-- Add Event -->
    <h4>Add New Event</h4>
    <input type="text" id="eventTitle" placeholder="Title">
    <input type="text" id="eventDesc" placeholder="Description">
    <input type="date" id="eventDate">
    <input type="text" id="eventVenue" placeholder="Venue">
    <button class="btn-add-event" onclick="addEvent()">Add Event</button>

    <!-- Events Table -->
    <h4>Your Events</h4>
    <div class="table-wrapper">
      <table id="eventsTable">
        <thead>
          <tr>
            <th>Title</th><th>Description</th><th>Date</th><th>Venue</th>
            <th>Status</th><th>Total Pledged</th><th>Total Collected</th><th>Balance</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const WORKER_URL = 'https://rapid-lab-7394.ev-dmaundu.workers.dev/';
    let userNationalId = "";

    function showWait() { document.getElementById("waitMsg").style.display = "block"; }
    function hideWait() { document.getElementById("waitMsg").style.display = "none"; }

    async function apiCall(action, payload) {
      showWait();
      try {
        const res = await fetch(WORKER_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action, ...payload })
        });
        return await res.json();
      } catch (err) {
        console.error(err);
        alert("Error contacting server: " + err.message);
        return { success: false, message: "Server error" };
      } finally {
        hideWait();
      }
    }

    async function login() {
      const nationalId = document.getElementById("nationalId").value;
      const password = document.getElementById("password").value;
      document.getElementById("loginMsg").textContent = "";
      const res = await apiCall('login', { nationalId, password });
      if(res.success){
        userNationalId = nationalId;
        document.getElementById("loginDiv").style.display = "none";
        document.getElementById("dashboard").style.display = "block";
        document.getElementById("welcomeMsg").textContent = "Welcome " + res.name;
        loadEvents();
      } else {
        document.getElementById("loginMsg").textContent = res.message || "Login failed";
      }
    }

    async function loadEvents() {
      const events = await apiCall('getEvents', { nationalId: userNationalId });
      const tbody = document.querySelector("#eventsTable tbody");
      tbody.innerHTML = "";
      events.forEach(ev => {
        const row = document.createElement("tr");
        row.setAttribute("data-eventid", ev.eventId);
        row.innerHTML = `
          <td>${ev.title}</td>
          <td>${ev.description}</td>
          <td>${ev.date}</td>
          <td>${ev.venue}</td>
          <td>${ev.status}</td>
          <td class="totalPledged">${ev.totalPledged}</td>
          <td class="totalCollected">${ev.totalCollected}</td>
          <td class="balance">${ev.balance}</td>
          <td>
            <button class="btn-add-contrib" onclick="showAddContributor('${ev.eventId}', this)">Add Contributor</button>
            <button class="btn-close" onclick="closeEvent('${ev.eventId}', this)">Close Event</button>
          </td>`;
        tbody.appendChild(row);
      });
    }

    async function addEvent() {
      const title = document.getElementById("eventTitle").value;
      const desc = document.getElementById("eventDesc").value;
      const date = document.getElementById("eventDate").value;
      const venue = document.getElementById("eventVenue").value;
      if(!title || !date) return alert("Title and Date required");
      await apiCall('addEvent', { nationalId: userNationalId, title, description: desc, date, venue });
      document.getElementById("eventTitle").value = "";
      document.getElementById("eventDesc").value = "";
      document.getElementById("eventDate").value = "";
      document.getElementById("eventVenue").value = "";
      loadEvents();
    }

    function showAddContributor(eventId, btn) {
      const tr = btn.closest("tr");
      if(tr.nextElementSibling && tr.nextElementSibling.classList.contains("addContributorRow")){
        tr.nextElementSibling.remove();
        return;
      }
      const row = document.createElement("tr");
      row.className = "addContributorRow";
      row.innerHTML = `<td colspan="9">
        Name: <input type="text" id="contribName_${eventId}">
        Phone: <input type="text" id="contribPhone_${eventId}">
        Amount: <input type="number" id="contribAmount_${eventId}">
        <button class="btn-add-contrib" onclick="addContributor('${eventId}', this)">Add</button>
      </td>`;
      tr.parentNode.insertBefore(row, tr.nextSibling);
    }

    async function addContributor(eventId, btn){
      const name = document.getElementById(`contribName_${eventId}`).value;
      const phone = document.getElementById(`contribPhone_${eventId}`).value;
      const amount = Number(document.getElementById(`contribAmount_${eventId}`).value);
      if(!name || !phone || !amount) return alert("Fill all fields");
      await apiCall('addContributor', { eventId, name, phone, amount });
      const tr = btn.closest("tr").previousElementSibling;
      const totalPledgedCell = tr.querySelector(".totalPledged");
      const balanceCell = tr.querySelector(".balance");
      totalPledgedCell.textContent = Number(totalPledgedCell.textContent) + amount;
      balanceCell.textContent = Number(balanceCell.textContent) + amount;
      tr.nextElementSibling.remove();
    }

    async function closeEvent(eventId, btn){
      if(!confirm("Close this event?")) return;
      await apiCall('closeEvent', { eventId });
      loadEvents();
    }
  </script>
</body>
</html>
